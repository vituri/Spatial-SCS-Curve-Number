---
title: "Soil analysis"
author: "Lucas Vituri Santarosa"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: cosmo
    self_contained: false
---

```{r setup, include=TRUE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, cache = TRUE, fig.width = 12)
```

## Loading libraries

```{r packages, warning=FALSE}
library(dplyr); library(purrr); library(glue)
library(terra)
```


## Downloading the data

Download the directories **Soil** and **LULC** from [this google drive](https://drive.google.com/drive/folders/18IXMdb04XiotG8TqD081JJGZex7gmJFP) and unzip them in your project folder.

```{r check files}
# check if the folders exist and are non-empty

c('Soil', 'LULC') %>% 
  walk(\(x) {
    if (!dir.exists(x)) {
      glue('Directory {x} does not exist! Download it using the link above') %>% print()
    } else if (length(list.files(x)) == 0) {
      glue('No files found at {x}! Did you unzip it correctly?') %>% print()
    } else {
      glue('{x} looks fine!') %>% print()
    }
  })
```

Set a directory that will be used to store all the temp files generated by `terra`

```{r create temp}
temp_directory_path = 'temp'
dir.create(path = temp_directory_path, showWarnings = FALSE) 
terraOptions(tempdir = temp_directory_path)
```

## Preparing the soil

Read the three layers of soil type

```{r read soil}
soil = c(
  terra::rast('Soil/clay.tif') %>% mean()
  ,terra::rast('Soil/sand.tif') %>% mean()
  ,terra::rast('Soil/silt.tif') %>% mean()
) / 1000

names(soil) = c('clay', 'sand', 'silt')
soil
```

```{r plot soil}

# plot the layers
plot(soil)

```

Notice that the sum of the three layers should be approximately 1

```{r sum soil}
sum(soil) %>% plot()
```

Define a function that, given the % of clay, sand and silt, calculates the type of soil. Check https://www.biologysimulations.com/post/how-to-use-the-soil-texture-triangle for more details.


```{r define triangle}
calculate_textural_triangle = function(clay, sand, silt) {

  dplyr::case_when(

    clay <= 0.05 & sand <= 0.05 & silt <= 0.05 ~ 0

    ,clay >= 0.35 ~ 4
    ,clay >= 0.25 & sand <= 0.45 ~ 4

    ,clay >= 0.2 & silt <= 0.275 ~ 3

    ,silt <= 0.5 ~ 2

    ,clay <= 0.075 ~ 1

    ,sand <= 0.575 ~ 2

    ,TRUE ~ 1
  )
}

```

Now classify the soil using the above function

```{r classify soil}
soil_classified = terra::app(
  soil, fun = function(x) calculate_textural_triangle(clay = x[,1], sand = x[,2], silt = x[,3])
  )
soil_classified %>% plot()
```

And finally reshape the raster

```{r reshape soil}
# reshape the soil
grid <- terra::rast(xmin = -53.1, xmax = -47, ymin = -23.5, ymax = -19.7, resolution = c(0.0025, .0025))
soil_final = project(soil_classified, grid) %>% terra::as.int()
soil_final
```

```{r plot soil final}
soil_final %>% plot()
```

## LULC
..................

## Cleaning
```{r}
unlink(temp_directory_path, recursive = TRUE)
```

